{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "urn:effortless:buildfix.apply.v1",
  "title": "buildfix.apply.v1",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "schema",
    "tool",
    "repo",
    "plan_ref",
    "preconditions",
    "results",
    "summary"
  ],
  "properties": {
    "schema": {
      "const": "buildfix.apply.v1"
    },
    "tool": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "name",
        "version"
      ],
      "properties": {
        "name": {
          "const": "buildfix"
        },
        "version": {
          "type": "string"
        },
        "commit": {
          "type": "string"
        }
      }
    },
    "repo": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "root"
      ],
      "properties": {
        "root": {
          "type": "string"
        },
        "head_sha_before": {
          "type": "string"
        },
        "head_sha_after": {
          "type": "string"
        },
        "dirty_before": {
          "type": "boolean"
        },
        "dirty_after": {
          "type": "boolean"
        }
      }
    },
    "plan_ref": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "path"
      ],
      "properties": {
        "path": {
          "type": "string"
        },
        "sha256": {
          "type": "string",
          "pattern": "^[0-9a-f]{64}$"
        }
      }
    },
    "preconditions": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "verified",
        "mismatches"
      ],
      "properties": {
        "verified": {
          "type": "boolean"
        },
        "mismatches": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": [
              "path",
              "expected",
              "actual"
            ],
            "properties": {
              "path": {
                "type": "string"
              },
              "expected": {
                "type": "string"
              },
              "actual": {
                "type": "string"
              }
            }
          },
          "default": []
        }
      }
    },
    "results": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/op_result"
      },
      "default": []
    },
    "summary": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "attempted",
        "applied",
        "blocked",
        "failed",
        "files_modified"
      ],
      "properties": {
        "attempted": {
          "type": "integer",
          "minimum": 0
        },
        "applied": {
          "type": "integer",
          "minimum": 0
        },
        "blocked": {
          "type": "integer",
          "minimum": 0
        },
        "failed": {
          "type": "integer",
          "minimum": 0
        },
        "files_modified": {
          "type": "integer",
          "minimum": 0
        }
      }
    },
    "errors": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "default": []
    }
  },
  "$defs": {
    "op_result": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "op_id",
        "status"
      ],
      "properties": {
        "op_id": {
          "type": "string"
        },
        "status": {
          "type": "string",
          "enum": [
            "applied",
            "blocked",
            "failed",
            "skipped"
          ]
        },
        "message": {
          "type": "string"
        },
        "blocked_reason": {
          "type": "string"
        },
        "blocked_reason_token": {
          "type": "string"
        },
        "files": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": [
              "path"
            ],
            "properties": {
              "path": {
                "type": "string"
              },
              "sha256_before": {
                "type": "string",
                "pattern": "^[0-9a-f]{64}$"
              },
              "sha256_after": {
                "type": "string",
                "pattern": "^[0-9a-f]{64}$"
              },
              "backup_path": {
                "type": "string"
              }
            }
          },
          "default": []
        }
      }
    }
  }
}